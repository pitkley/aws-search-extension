name: CI

on:
  push:
    branches:
    - main
    - staging
    - trying
  pull_request:
    branches:
    - main

jobs:
  check-license-headers:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Check license headers
      run: |
        ./hack/check-license-headers.sh

  yamllint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: yamllint
      uses: ibiqlik/action-yamllint@v3

  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Install node toolchain
      uses: actions/setup-node@v1
      with:
        node-version: '12'
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '^3.9'
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15.x
    - name: Install jsonnet
      run: go get github.com/google/go-jsonnet/cmd/jsonnet
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Get aws-cli submodule commit hash
      id: submodule-awscli-hash
      run: |
        hash="$(git rev-parse @:index-sources/aws-cli)"
        echo "::set-output name=hash::${hash}"
    - name: aws-cli docs cache
      uses: actions/cache@v2
      with:
        path: |
          index-sources/aws-cli/doc/build/
        key: awscli-docbuild-${{ steps.submodule-awscli-hash.outputs.hash }}

    - name: Check if up-to-date built aws-cli docs are available
      id: awscli-docs-available
      continue-on-error: true
      run: stat index-sources/aws-cli/doc/build/json
    - name: Build aws-cli docs
      if: "${{ (steps.awscli-docs-available.outcome == 'failure') }}"
      working-directory: index-sources/aws-cli/
      run: |
        pip install -r requirements.txt
        pip install -r requirements-docs.txt
        pip install -e .
        make -C doc json

    - run: npm install
    - name: 'Generate index: AWS CloudFormation'
      run: hack/generate-index-cfn.py
    - name: 'Generate index: AWS API reference'
      run: hack/generate-index-api.py
    - name: 'Generate index: AWS CLI reference'
      run: hack/generate-index-cli.py

    - name: 'Firefox: prepare manifest'
      run: make firefox
    - name: 'Firefox: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-firefox
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/firefox/

    - name: 'Chrome: prepare manifest'
      run: make chrome
    - name: 'Chrome: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-chrome
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/chrome/

    - name: 'Edge: prepare manifest'
      run: make edge
    - name: 'Edge: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-edge
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/edge/

    - name: Upload extension-ZIPs as artifact to workflow
      uses: actions/upload-artifact@v2
      with:
        name: aws-search-extension
        path: |
          ${{ steps.web-ext-build-firefox.outputs.target }}
          ${{ steps.web-ext-build-chrome.outputs.target }}
          ${{ steps.web-ext-build-edge.outputs.target }}
