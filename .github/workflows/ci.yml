name: CI

on:
  push:
    branches:
    - main
    - staging
    - trying
  pull_request:
    branches:
    - main

jobs:
  check-license-headers:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Check license headers
      run: |
        ./hack/check-license-headers.sh

  yamllint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: yamllint
      uses: ibiqlik/action-yamllint@v3

  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Install node toolchain
      uses: actions/setup-node@v1
      with:
        node-version: '12'
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '^3.9'
    - name: Install jsonnet
      run: sudo snap install jsonnet
    - name: Checkout
      uses: actions/checkout@v2
      with:
        submodules: recursive

    - run: npm install
    - name: 'Generate index: AWS CloudFormation'
      run: hack/generate-index-cfn.py
    - name: 'Generate index: AWS API reference'
      run: hack/generate-index-api.py

    - name: 'Firefox: prepare manifest'
      run: make firefox
    - name: 'Firefox: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-firefox
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/firefox/

    - name: 'Chrome: prepare manifest'
      run: make chrome
    - name: 'Chrome: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-chrome
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/chrome/

    - name: 'Edge: prepare manifest'
      run: make edge
    - name: 'Edge: web-ext build'
      uses: kewisch/action-web-ext@v1
      id: web-ext-build-edge
      with:
        cmd: build
        source: extension
        artifacts: web-ext-artifacts/edge/

    - name: Upload extension-ZIPs as artifact to workflow
      uses: actions/upload-artifact@v2
      with:
        name: aws-search-extension
        path: |
          ${{ steps.web-ext-build-firefox.outputs.target }}
          ${{ steps.web-ext-build-chrome.outputs.target }}
          ${{ steps.web-ext-build-edge.outputs.target }}
